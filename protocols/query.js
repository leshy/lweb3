// Generated by LiveScript 1.4.0
(function(){
  var _, Backbone, helpers, subscriptionMan, validator, v, core, util, p, query, queryToCallback, callbackToQuery, client, reply, serverServer, server;
  _ = require('underscore');
  Backbone = require('backbone4000');
  helpers = require('helpers');
  subscriptionMan = require('subscriptionman2');
  validator = require('validator2-extras');
  v = validator.v;
  core = require('../core');
  util = require('util');
  p = require('bluebird');
  query = core.core.extend4000({
    end: function(){
      this.get('unsubscribe')();
      return this.parent.endQuery(this.id);
    }
  });
  queryToCallback = exports.queryToCallback = function(callback){
    return function(msg, end){
      return callback(msg.err, msg.data);
    };
  };
  callbackToQuery = exports.callbackToQuery = function(res){
    return function(err, data){
      if (err) {
        err = String(err);
      }
      if (err) {
        return res.end({
          err: err
        });
      } else {
        return res.end({
          data: data
        });
      }
    };
  };
  client = exports.client = core.protocol.extend4000(validator.ValidatedModel, {
    validator: {
      timeout: v().Default(5000).Number()
    },
    defaults: {
      name: 'queryClient'
    },
    functions: function(){
      return {
        query: _.bind(this.send, this),
        queryP: _.bind(this.sendP, this)
      };
    },
    initialize: function(){
      var this$ = this;
      return this.when('parent', function(parent){
        parent.subscribe({
          type: 'reply',
          id: String
        }, function(msg){
          if (msg.end) {
            this$.log('Q completed', msg.payload, 'q-' + msg.id);
          } else {
            this$.log('Q reply', msg.payload, 'q-' + msg.id);
          }
          return this$.event(msg);
        });
        return parent.once('end', function(){
          return this$.end();
        });
      });
    },
    endQuery: function(id){
      this.log('canceling Q' + ' ' + id);
      return this.parent.send({
        type: 'queryCancel',
        id: id
      });
    },
    sendP: function(msg){
      var this$ = this;
      return new p(function(resolve, reject){
        var ret, first;
        ret = [];
        first = true;
        return this$.send(msg, function(data, end){
          var first;
          if (first && end) {
            return resolve(data);
          }
          first = false;
          if (end) {
            if (data) {
              ret.push(data);
            }
            return resolve(ret);
          } else {
            return res.push(data);
          }
        });
      });
    },
    send: function(msg, timeout, callback, callbackTimeout){
      var id, q, cancelTimeout, unsubscribe, this$ = this;
      if ((timeout != null ? timeout.constructor : void 8) === Function) {
        callbackTimeout = callback;
        callback = timeout;
        timeout = this.get('timeout');
      }
      this.parent.send({
        type: 'query',
        id: id = helpers.uuid(10),
        payload: msg
      });
      this.log('Q starting', msg, 'q-' + id);
      q = new query({
        parent: this,
        id: id
      });
      cancelTimeout = void 8;
      q.set({
        unsubscribe: unsubscribe = this.subscribe({
          type: 'reply',
          id: id
        }, function(msg){
          if (cancelTimeout) {
            cancelTimeout();
            cancelTimeout = undefined;
          }
          q.trigger('msg', msg.payload, msg.end);
          if (msg.end) {
            unsubscribe();
            q.trigger('end', msg.payload);
          }
          return helpers.cbc(callback, msg.payload, msg.end);
        })
      });
      if (timeout) {
        cancelTimeout = helpers.wait(timeout, function(){
          this$.log('Q timeout', msg, 'q-' + id);
          unsubscribe();
          return helpers.cbc(callbackTimeout);
        });
      }
      return q;
    }
  });
  reply = core.core.extend4000({
    initialize: function(){
      var this$ = this;
      this.set({
        name: this.get('id')
      });
      this.unsubscribe = this.parent.parent.subscribe({
        type: 'queryCancel',
        id: this.get('id')
      }, function(){
        this$.log('got query cancel request');
        return this$.cancel();
      });
      return this.parent.on('end', function(){
        return this$.cancel();
      });
    },
    write: function(msg){
      if (this.ended) {
        return false;
      }
      this.parent.send(msg, this.id, false);
      return true;
    },
    end: function(msg){
      if (!this.ended) {
        this.ended = true;
      } else {
        return;
      }
      this.unsubscribe();
      this.parent.send(msg, this.id, true);
      return this.trigger('end');
    },
    cancel: function(){
      this.ended = true;
      this.unsubscribe();
      this.trigger('cancel');
      return this.trigger('end');
    }
  });
  serverServer = exports.serverServer = core.protocol.extend4000({
    defaults: {
      name: 'queryServerServer'
    },
    functions: function(){
      var this$ = this;
      return {
        onQuery: _.bind(this.subscribe, this),
        onQueryWait: _.bind(this.subscribeWait, this),
        onQueryOnce: _.bind(this.subscribeOnce, this),
        onQueryError: function(callback){
          return this$.on('error', callback);
        }
      };
    },
    subscribe: function(pattern, callback){
      var this$ = this;
      return subscriptionMan.fancy.prototype.subscribe.call(this, pattern, function(payload, id, realm){
        var r, error;
        r = new reply({
          id: id,
          parent: realm.client.queryServer,
          realm: realm
        });
        try {
          return callback(payload, r, realm);
        } catch (e$) {
          error = e$;
          return this$.trigger("error", payload, r, realm, error, pattern);
        }
      });
    },
    initialize: function(){
      var this$ = this;
      return this.when('parent', function(parent){
        parent.on('connect', function(client){
          return client.addProtocol(new server({
            verbose: this$.verbose,
            core: this$
          }));
        });
        return _.map(parent.clients, function(client, id){
          return client.addProtocol(new server({
            verbose: this$.verbose,
            core: this$
          }));
        });
      });
    },
    channel: function(channel){
      return channel.addProtocol(new server({
        verbose: this.get('verbose')
      }));
    }
  });
  server = exports.server = core.protocol.extend4000({
    defaults: {
      name: 'queryServer'
    },
    functions: function(){
      return {
        onQuery: _.bind(this.subscribe, this)
      };
    },
    initialize: function(){
      var this$ = this;
      this.when('core', function(core){
        return this$.core = core;
      });
      return this.when('parent', function(parent){
        parent.subscribe({
          type: 'query',
          payload: true
        }, function(msg, realm){
          var ref$;
          this$.log('query receive ' + util.inspect(msg.payload, {
            depth: 0
          }), {
            payload: msg.payload
          }, 'q-' + msg.id);
          this$.event(msg.payload, msg.id, realm);
          return (ref$ = this$.core) != null ? ref$.event(msg.payload, msg.id, realm) : void 8;
        });
        return parent.on('end', function(){
          return this$.end();
        });
      });
    },
    send: function(payload, id, end){
      var msg;
      end == null && (end = false);
      msg = {
        type: 'reply',
        payload: payload,
        id: id
      };
      if (end) {
        msg.end = true;
      } else {}
      return this.parent.send(msg);
    },
    subscribe: function(pattern, callback){
      var this$ = this;
      pattern == null && (pattern = true);
      return subscriptionMan.fancy.prototype.subscribe.call(this, pattern, function(payload, id, realm){
        return callback(payload, new reply({
          id: id,
          parent: this$,
          realm: realm
        }), realm);
      });
    }
  });
}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2xlc2gvY29kaW5nL25vZGUvbHdlYjMvcHJvdG9jb2xzL3F1ZXJ5LmxzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztFQUFBLENBQUUsQ0FBQSxDQUFBLENBQUUsUUFBUSxZQUFBO0VBQ1osUUFBUyxDQUFBLENBQUEsQ0FBRSxRQUFRLGNBQUE7RUFDbkIsT0FBUSxDQUFBLENBQUEsQ0FBRSxRQUFRLFNBQUE7RUFFbEIsZUFBZ0IsQ0FBQSxDQUFBLENBQUUsUUFBUSxrQkFBRDtFQUN6QixTQUFVLENBQUEsQ0FBQSxDQUFFLFFBQVEsbUJBQUQ7RUFBdUIsQ0FBRSxDQUFBLENBQUEsQ0FBRSxTQUFTLENBQUM7RUFFeEQsSUFBSyxDQUFBLENBQUEsQ0FBRSxRQUFRLFNBQUE7RUFDZixJQUFLLENBQUEsQ0FBQSxDQUFFLFFBQVEsTUFBQTtFQUNmLENBQUUsQ0FBQSxDQUFBLENBQUUsUUFBUSxVQUFBO0VBRVosS0FBTSxDQUFBLENBQUEsQ0FBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQ2Q7SUFBQSxLQUFLLFFBQUEsQ0FBQTtNQUNELElBQUMsQ0FBQSxJQUFJLGFBQUQsRUFBZTthQUNuQixJQUFDLENBQUEsTUFBTSxDQUFDLFNBQVMsSUFBQyxDQUFBLEVBQUQ7O0VBRnJCLENBQUE7RUFJSixlQUFnQixDQUFBLENBQUEsQ0FBRSxPQUFPLENBQUMsZUFBZ0IsQ0FBQSxDQUFBLENBQUUsUUFBQSxDQUFBLFFBQUE7V0FDMUMsUUFBQSxDQUFBLEdBQUEsRUFBQSxHQUFBO2FBRUUsU0FBUyxHQUFHLENBQUMsS0FBSyxHQUFHLENBQUMsSUFBYjs7O0VBRWIsZUFBZ0IsQ0FBQSxDQUFBLENBQUUsT0FBTyxDQUFDLGVBQWdCLENBQUEsQ0FBQSxDQUFFLFFBQUEsQ0FBQSxHQUFBO1dBQVMsUUFBQSxDQUFBLEdBQUEsRUFBQSxJQUFBO01BQ25ELElBQUcsR0FBSDtRQUFZLEdBQUksQ0FBQSxDQUFBLENBQUUsT0FBTyxHQUFEOztNQUN4QixJQUFHLEdBQUg7ZUFB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QUE7YUFFQSxJQUFDLENBQUEsTUFBTSxDQUFDLEtBQUssR0FBQTs7SUFFakIsV0FBVyxRQUFBLENBQUEsT0FBQSxFQUFBLFFBQUE7O01BQUMsb0JBQUEsVUFBUTthQUNoQixlQUFlLENBQUMsS0FBSyxDQUFBLFNBQUUsQ0FBQSxTQUFTLENBQUMsS0FBSyxNQUFHLFNBQVMsUUFBQSxDQUFBLE9BQUEsRUFBQSxFQUFBLEVBQUEsS0FBQTtlQUM5QyxTQUFTLGFBQWEsTUFBTTtVQUFBLElBQUk7VUFBSSxRQUFRO1VBQUcsT0FBTztRQUExQixDQUFELEdBQW1DLEtBQXJEO09BRHlCOztFQTNCMUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIl8gPSByZXF1aXJlICd1bmRlcnNjb3JlJ1xuQmFja2JvbmUgPSByZXF1aXJlICdiYWNrYm9uZTQwMDAnXG5oZWxwZXJzID0gcmVxdWlyZSAnaGVscGVycydcblxuc3Vic2NyaXB0aW9uTWFuID0gcmVxdWlyZSgnc3Vic2NyaXB0aW9ubWFuMicpXG52YWxpZGF0b3IgPSByZXF1aXJlKCd2YWxpZGF0b3IyLWV4dHJhcycpOyB2ID0gdmFsaWRhdG9yLnZcblxuY29yZSA9IHJlcXVpcmUgJy4uL2NvcmUnXG51dGlsID0gcmVxdWlyZSAndXRpbCdcbnAgPSByZXF1aXJlICdibHVlYmlyZCdcblxucXVlcnkgPSBjb3JlLmNvcmUuZXh0ZW5kNDAwMCBkb1xuICAgIGVuZDogLT5cbiAgICAgICAgQGdldCgndW5zdWJzY3JpYmUnKSgpXG4gICAgICAgIEBwYXJlbnQuZW5kUXVlcnkgQGlkXG5cbnF1ZXJ5VG9DYWxsYmFjayA9IGV4cG9ydHMucXVlcnlUb0NhbGxiYWNrID0gKGNhbGxiYWNrKSAtPlxuICAobXNnLGVuZCkgLT5cbiAgICAjaWYgbm90IGVuZCB0aGVuIHRocm93IFwidGhpcyBxdWVyeSBpcyBzdXBwb3NlZCB0byBiZSB0cmFuc2xhdGVkIHRvIGNhbGxiYWNrIGJ1dCBJIGdvdCBtdWx0aXBsZSByZXNwb25zZXNcIlxuICAgIGNhbGxiYWNrIG1zZy5lcnIsIG1zZy5kYXRhXG5cbmNhbGxiYWNrVG9RdWVyeSA9IGV4cG9ydHMuY2FsbGJhY2tUb1F1ZXJ5ID0gKHJlcykgLT4gKGVycixkYXRhKSAtPlxuICBpZiBlcnIgdGhlbiBlcnIgPSBTdHJpbmcoZXJyKVxuICBpZiBlcnIgdGhlbiByZXMuZW5kIGVycjogZXJyXG4gIGVsc2UgcmVzLmVuZCBkYXRhOiBkYXRhXG5cbmNsaWVudCA9IGV4cG9ydHMuY2xpZW50ID0gY29yZS5wcm90b2NvbC5leHRlbmQ0MDAwIHZhbGlkYXRvci5WYWxpZGF0ZWRNb2RlbCxcbiAgICB2YWxpZGF0b3I6XG4gICAgICAgIHRpbWVvdXQ6IHYoKS5EZWZhdWx0KDUwMDApLk51bWJlcigpXG5cbiAgICBkZWZhdWx0czpcbiAgICAgICAgbmFtZTogJ3F1ZXJ5Q2xpZW50J1xuXG4gICAgZnVuY3Rpb25zOiAtPlxuICAgICAgICBxdWVyeTogXy5iaW5kIEBzZW5kLCBAXG4gICAgICAgIHF1ZXJ5UDogXy5iaW5kIEBzZW5kUCwgQFxuXG4gICAgaW5pdGlhbGl6ZTogLT5cbiAgICAgICAgQHdoZW4gJ3BhcmVudCcsIChwYXJlbnQpIH4+XG4gICAgICAgICAgICBwYXJlbnQuc3Vic2NyaWJlIHsgdHlwZTogJ3JlcGx5JywgaWQ6IFN0cmluZyB9LCAobXNnKSB+PlxuICAgICAgICAgICAgICAgIGlmIG1zZy5lbmQgdGhlbiBAbG9nICdRIGNvbXBsZXRlZCcsIG1zZy5wYXlsb2FkICwgJ3EtJyArIG1zZy5pZFxuICAgICAgICAgICAgICAgIGVsc2UgQGxvZyAnUSByZXBseScsIG1zZy5wYXlsb2FkLCAncS0nICsgbXNnLmlkXG5cbiAgICAgICAgICAgICAgICBAZXZlbnQgbXNnXG4gICAgICAgICAgICBwYXJlbnQub25jZSAnZW5kJywgfj4gQGVuZCgpXG5cbiAgICBlbmRRdWVyeTogKGlkKSAtPlxuICAgICAgICBAbG9nICdjYW5jZWxpbmcgUScgKyAnICcgKyBpZFxuICAgICAgICBAcGFyZW50LnNlbmQgeyB0eXBlOiAncXVlcnlDYW5jZWwnLCBpZDogaWQgfVxuXG4gICAgIyBhIGJpdCB1Z2x5LCBidXQgd29ya3MgZm9yIG5vd1xuICAgIHNlbmRQOiAobXNnKSAtPiBuZXcgcCAocmVzb2x2ZSxyZWplY3QpIH4+XG4gICAgICByZXQgPSBbXVxuICAgICAgZmlyc3QgPSB0cnVlXG4gICAgICBAc2VuZCBtc2csIChkYXRhLCBlbmQpIC0+XG4gICAgICAgIGlmIGZpcnN0IGFuZCBlbmQgdGhlbiByZXR1cm4gcmVzb2x2ZSBkYXRhXG4gICAgICAgIGZpcnN0ID0gZmFsc2VcblxuICAgICAgICBpZiBlbmRcbiAgICAgICAgICBpZiBkYXRhIHRoZW4gcmV0LnB1c2ggZGF0YVxuICAgICAgICAgIHJlc29sdmUgcmV0XG4gICAgICAgIGVsc2VcbiAgICAgICAgICByZXMucHVzaCBkYXRhXG5cbiAgICBzZW5kOiAobXNnLCB0aW1lb3V0LCBjYWxsYmFjaywgY2FsbGJhY2tUaW1lb3V0KSAtPlxuICAgICAgICBpZiB0aW1lb3V0Py5jb25zdHJ1Y3RvciBpcyBGdW5jdGlvblxuICAgICAgICAgICAgY2FsbGJhY2tUaW1lb3V0ID0gY2FsbGJhY2tcbiAgICAgICAgICAgIGNhbGxiYWNrID0gdGltZW91dFxuICAgICAgICAgICAgdGltZW91dCA9IEBnZXQoJ3RpbWVvdXQnKVxuXG4gICAgICAgIEBwYXJlbnQuc2VuZCB7IHR5cGU6ICdxdWVyeScsIGlkOiBpZCA9IGhlbHBlcnMudXVpZCgxMCksIHBheWxvYWQ6IG1zZyB9XG4gICAgICAgIEBsb2cgJ1Egc3RhcnRpbmcnLCBtc2csICdxLScgKyBpZFxuXG4gICAgICAgIHEgPSBuZXcgcXVlcnkgcGFyZW50OiBALCBpZDogaWRcblxuICAgICAgICBjYW5jZWxUaW1lb3V0ID0gdm9pZDtcbiAgICAgICAgXG4gICAgICAgIHEuc2V0IHVuc3Vic2NyaWJlOiB1bnN1YnNjcmliZSA9IEBzdWJzY3JpYmUgeyB0eXBlOiAncmVwbHknLCBpZDogaWQgfSwgKG1zZykgfj5cbiAgICAgICAgICBpZiBjYW5jZWxUaW1lb3V0IHRoZW4gY2FuY2VsVGltZW91dCgpOyBjYW5jZWxUaW1lb3V0IDo9IHVuZGVmaW5lZFxuICAgICAgICAgIHEudHJpZ2dlciAnbXNnJywgbXNnLnBheWxvYWQsIG1zZy5lbmRcbiAgICAgICAgICBpZiBtc2cuZW5kIHRoZW4gdW5zdWJzY3JpYmUoKTsgcS50cmlnZ2VyICdlbmQnLCBtc2cucGF5bG9hZFxuICAgICAgICAgIGhlbHBlcnMuY2JjIGNhbGxiYWNrLCBtc2cucGF5bG9hZCwgbXNnLmVuZFxuXG4gICAgICAgIGlmIHRpbWVvdXRcbiAgICAgICAgICBjYW5jZWxUaW1lb3V0ID0gaGVscGVycy53YWl0IHRpbWVvdXQsIH4+XG4gICAgICAgICAgICBAbG9nICdRIHRpbWVvdXQnLCBtc2csICdxLScgKyBpZFxuICAgICAgICAgICAgdW5zdWJzY3JpYmUoKVxuICAgICAgICAgICAgaGVscGVycy5jYmMgY2FsbGJhY2tUaW1lb3V0XG5cbiAgICAgICAgcmV0dXJuIHFcblxucmVwbHkgPSBjb3JlLmNvcmUuZXh0ZW5kNDAwMCBkb1xuICAgIGluaXRpYWxpemU6IC0+XG4gICAgICAgIEBzZXQgbmFtZTogQGdldCAnaWQnXG4gICAgICAgIEB1bnN1YnNjcmliZSA9IEBwYXJlbnQucGFyZW50LnN1YnNjcmliZSB0eXBlOiAncXVlcnlDYW5jZWwnLCBpZDogQGdldCgnaWQnKSwgfj5cbiAgICAgICAgICAgIEBsb2cgJ2dvdCBxdWVyeSBjYW5jZWwgcmVxdWVzdCdcbiAgICAgICAgICAgIEBjYW5jZWwoKVxuXG4gICAgICAgIEBwYXJlbnQub24gJ2VuZCcsIH4+IEBjYW5jZWwoKVxuXG4gICAgd3JpdGU6IChtc2cpIC0+XG4jICAgICAgICBpZiBAZW5kZWQgdGhlbiB0aHJvdyBcInRoaXMgcmVwbHkgaGFzIGVuZGVkXCJcbiAgICAgICAgaWYgQGVuZGVkIHRoZW4gcmV0dXJuIGZhbHNlXG4gICAgICAgIEBwYXJlbnQuc2VuZCBtc2csIEBpZCwgZmFsc2VcbiAgICAgICAgcmV0dXJuIHRydWVcblxuICAgIGVuZDogKG1zZykgLT5cbiAgICAgICAgaWYgbm90IEBlbmRlZCB0aGVuIEBlbmRlZCA9IHRydWUgZWxzZSByZXR1cm5cbiAgICAgICAgQHVuc3Vic2NyaWJlKClcbiAgICAgICAgQHBhcmVudC5zZW5kIG1zZywgQGlkLCB0cnVlXG4gICAgICAgIEB0cmlnZ2VyICdlbmQnXG5cbiAgICBjYW5jZWw6IC0+XG4gICAgICAgIEBlbmRlZCA9IHRydWVcbiAgICAgICAgQHVuc3Vic2NyaWJlKClcbiAgICAgICAgQHRyaWdnZXIgJ2NhbmNlbCdcbiAgICAgICAgQHRyaWdnZXIgJ2VuZCdcblxuXG5zZXJ2ZXJTZXJ2ZXIgPSBleHBvcnRzLnNlcnZlclNlcnZlciA9IGNvcmUucHJvdG9jb2wuZXh0ZW5kNDAwMCBkb1xuICAgIGRlZmF1bHRzOlxuICAgICAgICBuYW1lOiAncXVlcnlTZXJ2ZXJTZXJ2ZXInXG5cbiAgICBmdW5jdGlvbnM6IC0+XG4gICAgICAgIG9uUXVlcnk6IF8uYmluZCBAc3Vic2NyaWJlLCBAXG4gICAgICAgIG9uUXVlcnlXYWl0OiBfLmJpbmQgQHN1YnNjcmliZVdhaXQsIEBcbiAgICAgICAgb25RdWVyeU9uY2U6IF8uYmluZCBAc3Vic2NyaWJlT25jZSwgQFxuICAgICAgICBvblF1ZXJ5RXJyb3I6IChjYWxsYmFjaykgfj5cbiAgICAgICAgICAgIEBvbiAnZXJyb3InLCBjYWxsYmFja1xuXG4gICAgc3Vic2NyaWJlOiAocGF0dGVybixjYWxsYmFjaykgLT5cbiAgICAgICAgc3Vic2NyaXB0aW9uTWFuLmZhbmN5OjpzdWJzY3JpYmUuY2FsbCBALCBwYXR0ZXJuLCAocGF5bG9hZCwgaWQsIHJlYWxtKSB+PlxuICAgICAgICAgICAgciA9IG5ldyByZXBseShpZDogaWQsIHBhcmVudDogcmVhbG0uY2xpZW50LnF1ZXJ5U2VydmVyLCByZWFsbTogcmVhbG0pXG4gICAgICAgICAgICB0cnlcbiAgICAgICAgICAgICAgICBjYWxsYmFjayBwYXlsb2FkLCByLCByZWFsbVxuICAgICAgICAgICAgY2F0Y2ggZXJyb3JcbiAgICAgICAgICAgICAgICBAdHJpZ2dlciBcImVycm9yXCIsIHBheWxvYWQsIHIsIHJlYWxtLCBlcnJvciwgcGF0dGVyblxuXG4gICAgaW5pdGlhbGl6ZTogLT5cbiAgICAgICAgQHdoZW4gJ3BhcmVudCcsIChwYXJlbnQpIH4+XG4gICAgICAgICAgICBwYXJlbnQub24gJ2Nvbm5lY3QnLCAoY2xpZW50KSB+PlxuICAgICAgICAgICAgICAgIGNsaWVudC5hZGRQcm90b2NvbCBuZXcgc2VydmVyIHZlcmJvc2U6IEB2ZXJib3NlLCBjb3JlOiBAXG5cbiAgICAgICAgICAgIF8ubWFwIHBhcmVudC5jbGllbnRzLCAoY2xpZW50LGlkKSB+PlxuICAgICAgICAgICAgICAgIGNsaWVudC5hZGRQcm90b2NvbCBuZXcgc2VydmVyIHZlcmJvc2U6IEB2ZXJib3NlLCBjb3JlOiBAXG5cbiAgICBjaGFubmVsOiAoY2hhbm5lbCkgLT5cbiAgICAgICAgY2hhbm5lbC5hZGRQcm90b2NvbCBuZXcgc2VydmVyIHZlcmJvc2U6IEBnZXQgJ3ZlcmJvc2UnXG5cblxuc2VydmVyID0gZXhwb3J0cy5zZXJ2ZXIgPSBjb3JlLnByb3RvY29sLmV4dGVuZDQwMDAgZG9cbiAgICBkZWZhdWx0czpcbiAgICAgICAgbmFtZTogJ3F1ZXJ5U2VydmVyJ1xuXG4gICAgZnVuY3Rpb25zOiAtPlxuICAgICAgICBvblF1ZXJ5OiBfLmJpbmQgQHN1YnNjcmliZSwgQFxuXG4gICAgaW5pdGlhbGl6ZTogLT5cbiAgICAgICAgQHdoZW4gJ2NvcmUnLCAoY29yZSkgfj4gQGNvcmUgPSBjb3JlXG5cbiAgICAgICAgQHdoZW4gJ3BhcmVudCcsIChwYXJlbnQpIH4+XG4gICAgICAgICAgICBwYXJlbnQuc3Vic2NyaWJlIHsgdHlwZTogJ3F1ZXJ5JywgcGF5bG9hZDogdHJ1ZSB9LCAobXNnLCByZWFsbSkgfj5cbiAgICAgICAgICAgICAgICBAbG9nICdxdWVyeSByZWNlaXZlICcgKyB1dGlsLmluc3BlY3QobXNnLnBheWxvYWQsIGRlcHRoOiAwKSwgeyBwYXlsb2FkOiBtc2cucGF5bG9hZCB9LCAncS0nICsgbXNnLmlkXG4gICAgICAgICAgICAgICAgQGV2ZW50IG1zZy5wYXlsb2FkLCBtc2cuaWQsIHJlYWxtXG4gICAgICAgICAgICAgICAgQGNvcmU/LmV2ZW50IG1zZy5wYXlsb2FkLCBtc2cuaWQsIHJlYWxtXG5cbiAgICAgICAgICAgIHBhcmVudC5vbiAnZW5kJywgfj4gQGVuZCgpXG5cbiAgICBzZW5kOiAocGF5bG9hZCxpZCxlbmQ9ZmFsc2UpIC0+XG4gICAgICAgIG1zZyA9IHsgdHlwZTogJ3JlcGx5JywgcGF5bG9hZDogcGF5bG9hZCwgaWQ6IGlkIH1cbiAgICAgICAgaWYgZW5kXG4gICAgICAgICAgbXNnLmVuZCA9IHRydWVcbiMgICAgICAgICAgQGxvZyAncXVlcnkgZW5kICcgKyB1dGlsLmluc3BlY3QocGF5bG9hZCwgZGVwdGg6IDApLCB7IHBheWxvYWQ6IHBheWxvYWQgfSwgJ3EtJyArIGlkXG4gICAgICAgIGVsc2VcbiMgICAgICAgICAgQGxvZyAncXVlcnkgcmVwbHkgJyArIHV0aWwuaW5zcGVjdChwYXlsb2FkLCBkZXB0aDogMCksIHsgcGF5bG9hZDogcGF5bG9hZCB9LCAncS0nICsgaWRcbiAgICAgICAgQHBhcmVudC5zZW5kIG1zZ1xuXG4gICAgc3Vic2NyaWJlOiAocGF0dGVybj10cnVlLCBjYWxsYmFjaykgLT5cbiAgICAgICAgc3Vic2NyaXB0aW9uTWFuLmZhbmN5OjpzdWJzY3JpYmUuY2FsbCBALCBwYXR0ZXJuLCAocGF5bG9hZCwgaWQsIHJlYWxtKSB+PlxuICAgICAgICAgICAgY2FsbGJhY2sgcGF5bG9hZCwgbmV3IHJlcGx5KGlkOiBpZCwgcGFyZW50OiBALCByZWFsbTogcmVhbG0pLCByZWFsbVxuXG4iXX0=
